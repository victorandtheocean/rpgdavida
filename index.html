<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG da Vida</title>
    
    <!-- PWA & iOS Icons -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00e5ff">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <style>
        :root {
            --primary: #00e5ff;
            --secondary: #004d40;
            --danger: #ff5252;
            --warning: #ffab40;
            --success: #69f0ae;
            --glass: rgba(0, 20, 40, 0.85); 
            --glass-border: rgba(255, 255, 255, 0.15);
            --gold: #ffd700;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #000; 
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9);
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 16px;
        }

        /* V√≠deo de Fundo */
        #bgVideo {
            position: fixed; right: 0; bottom: 0;
            min-width: 100%; min-height: 100%;
            width: auto; height: auto; z-index: -5;
            object-fit: cover; background: #000;
        }
        .video-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); z-index: -4; pointer-events: none;
        }

        #app { max-width: 600px; margin: 0 auto; padding: 15px; padding-bottom: 80px; }
        .screen { display: none; animation: fadeIn 0.3s ease-out; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI Components */
        .card {
            background: var(--glass); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px;
            margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        h1, h2, h3, h4 { margin-top: 0; color: white; }
        p { line-height: 1.5; opacity: 0.9; }

        button {
            background: linear-gradient(45deg, var(--secondary), #00695c);
            border: 1px solid rgba(255,255,255,0.2); color: white;
            padding: 16px; border-radius: 16px; cursor: pointer;
            font-size: 1rem; font-weight: bold; width: 100%; margin-top: 10px;
            text-transform: uppercase; letter-spacing: 0.5px;
            text-shadow: 0 1px 2px black; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        button:active { transform: scale(0.98); background: var(--primary); color: black; text-shadow: none; }
        
        button.secondary { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); font-size: 0.9rem; padding: 12px; text-transform: none; }
        button.danger { background: rgba(255, 82, 82, 0.2); border-color: var(--danger); color: var(--danger); }
        button.icon-btn { width: auto; padding: 10px 15px; margin: 0; font-size: 1.2rem; display: inline-flex; align-items: center; justify-content: center; }

        input, select {
            width: 100%; padding: 16px; margin: 8px 0 16px 0;
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0, 0, 0, 0.6); color: white;
            font-size: 1rem; -webkit-appearance: none;
        }
        input::placeholder { color: rgba(255,255,255,0.5); }
        input:focus { outline: none; border-color: var(--primary); background: rgba(0,0,0,0.8); }

        /* Grid de √Åreas */
        .area-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .area-btn {
            aspect-ratio: 1 / 1; border-radius: 20px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 1rem; background: rgba(0,0,0,0.4); border: 2px solid rgba(255,255,255,0.1); 
            cursor: pointer; position: relative; text-align: center; padding: 10px;
        }
        .area-btn:active { background: rgba(255,255,255,0.1); border-color: var(--primary); }
        .area-icon-display { font-size: 2.5rem; margin-bottom: 8px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8)); }
        
        .area-btn.editing { border-color: var(--warning); border-style: dashed; animation: shake 0.3s; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(1deg); } 75% { transform: rotate(-1deg); } 100% { transform: rotate(0deg); } }
        
        .edit-controls { position: absolute; top: -10px; right: -10px; display: flex; gap: 5px; z-index: 10; }
        .mini-btn { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; border: 2px solid white; padding: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .btn-del { background: var(--danger); }
        .btn-edit { background: var(--primary); color: black; text-shadow: none; }

        /* Bolhas */
        .bubble-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; padding: 20px 0; }
        .objective-bubble {
            width: 140px; height: 140px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), rgba(0,0,0,0.8));
            border: 3px solid var(--primary);
            box-shadow: inset 0 0 20px rgba(0,229,255,0.2), 0 5px 15px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; cursor: pointer; animation: float 6s ease-in-out infinite;
            padding: 10px; word-wrap: break-word;
        }
        .objective-bubble:active { transform: scale(0.95); }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        /* Lista de Metas */
        .goal-item {
            display: flex; align-items: center; background: rgba(0,0,0,0.5);
            padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);
        }
        .goal-item input[type="checkbox"] { width: 24px; height: 24px; margin: 0 15px 0 0; flex-shrink: 0; }
        .goal-text { flex-grow: 1; font-size: 1rem; line-height: 1.4; color: white; }

        /* Barra XP */
        .xp-bar-container {
            width: 100%; height: 30px; background: #000; border-radius: 15px;
            overflow: hidden; margin: 15px 0; border: 2px solid #555; position: relative;
        }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--secondary), var(--primary)); width: 0%; transition: width 0.5s ease; }
        .xp-bar-fill.negative { background: linear-gradient(90deg, #b71c1c, var(--danger)); }
        .xp-text { position: absolute; width: 100%; text-align: center; top: 4px; font-size: 0.85rem; font-weight: bold; text-shadow: 1px 1px 3px black; z-index: 2; color: white; }

        /* Anima√ß√£o B√¥nus */
        .reward-container {
            background: rgba(0,0,0,0.6); padding: 15px; border-radius: 15px; margin-top: 15px;
            position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); transition: all 0.5s;
        }
        .reward-locked { filter: grayscale(1); opacity: 0.7; }
        .reward-locked .reward-text { filter: blur(4px); }
        .lock-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; }
        .reward-revealed { background: rgba(255, 215, 0, 0.15); border-color: var(--gold); animation: pulseGold 2s infinite alternate; }
        .reward-revealed .reward-text { filter: blur(0); color: var(--gold); font-weight: bold; text-shadow: 0 2px 4px black; }
        .reward-revealed::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
            animation: wavePass 1.5s ease-out forwards;
        }
        @keyframes wavePass { 0% { left: -100%; } 100% { left: 200%; } }
        @keyframes pulseGold { from { box-shadow: 0 0 5px rgba(255, 215, 0, 0.2); } to { box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); } }

        /* Modais */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal-content { width: 100%; max-width: 400px; max-height: 85vh; overflow-y: auto; }
        
        /* Lista de Ajuda */
        .help-list { text-align: left; padding-left: 20px; margin-bottom: 20px; }
        .help-list li { margin-bottom: 10px; }

    </style>
</head>
<body>

    <video autoplay muted loop playsinline id="bgVideo">
        <source src="fundo.mp4" type="video/mp4">
    </video>
    <div class="video-overlay"></div>

    <div id="app">
        <!-- TELA 1: Login -->
        <div id="screen-login" class="screen active">
            <div class="card" style="text-align: center; margin-top: 10vh;">
                <h1>üåä RPG da Vida</h1>
                <p style="opacity: 0.9;">Sua jornada no fundo do mar</p>
                <input type="text" id="userName" placeholder="Seu Nome" onkeypress="game.handleEnter(event, 'login')">
                <div style="margin: 20px 0;">
                    <label>Escolha seu Avatar:</label>
                    <select id="userAvatar" style="font-size: 2rem; text-align: center; height: 70px;">
                        <option value="üßú‚Äç‚ôÇÔ∏è">üßú‚Äç‚ôÇÔ∏è</option>
                        <option value="üßú‚Äç‚ôÄÔ∏è">üßú‚Äç‚ôÄÔ∏è</option>
                        <option value="ü¶à">ü¶à</option>
                        <option value="üê¢">üê¢</option>
                        <option value="üêô">üêô</option>
                    </select>
                </div>
                <button onclick="game.login()">Come√ßar</button>
            </div>
        </div>

        <!-- TELA 2: Dashboard -->
        <div id="screen-dashboard" class="screen">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 id="welcomeMsg" style="margin:0; font-size: 1.3rem;">Ol√°</h2>
                <div style="display: flex; gap: 10px;">
                    <!-- BOT√ÉO DE AJUDA AQUI -->
                    <button onclick="game.openHelp()" class="secondary icon-btn" style="background: rgba(0, 229, 255, 0.2); border-color: var(--primary);">‚ùì</button>
                    <button onclick="game.logout()" class="secondary icon-btn">üö™</button>
                </div>
            </div>
            
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin:0">√Åreas</h3>
                    <button onclick="game.toggleEditAreas()" id="btnEditAreas" class="secondary" style="width: auto; padding: 8px 12px;">‚úèÔ∏è Editar</button>
                </div>
                <p id="editAreaTip" style="display:none; font-size:0.85rem; color:var(--warning); text-align:center; margin-bottom:15px;">Toque no l√°pis para renomear ou no X para apagar.</p>
                <div id="areasGrid" class="area-grid"></div>
            </div>
        </div>

        <!-- TELA 3: Objetivos -->
        <div id="screen-area" class="screen">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <button onclick="game.showScreen('screen-dashboard')" class="secondary icon-btn">‚¨Ö</button>
                <h2 id="areaTitle" style="margin:0; font-size: 1.4rem; text-align:center; flex-grow:1;">√Årea</h2>
                <div style="width: 40px;"></div>
            </div>
            
            <div class="card" style="text-align: center; padding: 15px;">
                <button onclick="game.openModal('create')" style="margin:0;">+ Novo Objetivo</button>
            </div>

            <div id="bubblesContainer" class="bubble-container"></div>
        </div>

        <!-- TELA 4: Miss√£o -->
        <div id="screen-mission" class="screen">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <button onclick="game.backToArea()" class="secondary icon-btn">‚¨Ö</button>
                <button onclick="game.openModal('edit')" class="secondary icon-btn">‚öôÔ∏è</button>
            </div>
            
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex-grow: 1; padding-right: 10px;">
                        <h2 id="missionTitle" style="margin:0; text-align: left; font-size: 1.3rem;">T√≠tulo</h2>
                        <p id="missionDeadline" style="margin: 5px 0; opacity: 0.8; font-size: 0.9rem;">Prazo: --/--</p>
                    </div>
                    <span id="missionLevel" style="background: var(--primary); color: black; padding: 5px 10px; border-radius: 8px; font-weight: bold; font-size: 0.8rem; white-space: nowrap; text-shadow: none;">Nvl 1</span>
                </div>
                
                <div id="rewardContainer" class="reward-container reward-locked">
                    <div class="lock-icon">üîí</div>
                    <div style="font-size: 0.75rem; opacity: 0.8;">Recompensa:</div>
                    <div id="missionReward" class="reward-text">...</div>
                </div>
                
                <div class="xp-bar-container">
                    <div id="xpBarFill" class="xp-bar-fill"></div>
                    <div id="xpText" class="xp-text">0 / 100 XP</div>
                </div>
                <p id="xpBalanceMsg" style="font-size: 0.8rem; text-align: center; opacity: 0.7; margin: 0;"></p>
            </div>

            <div class="card">
                <h3>üìã Metas</h3>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="newGoalInput" placeholder="Nova meta..." onkeypress="game.handleEnter(event, 'addGoal')" style="margin:0;">
                    <button onclick="game.addGoal()" style="width: 50px; font-size: 1.5rem; padding: 0; margin:0;">+</button>
                </div>
                <div id="goalsList" style="margin-top: 20px;"></div>
            </div>

            <button id="btnLevelUp" onclick="game.levelUp()" style="display: none; background: var(--success); color: black; margin-bottom: 50px; text-shadow: none;">
                üéâ COMPLETAR N√çVEL
            </button>
        </div>

        <!-- MODAL: Ajuda / Tutorial -->
        <div id="modal-help" class="modal-overlay">
            <div class="card modal-content">
                <h3 style="text-align: center; color: var(--primary);">üìñ Como Jogar</h3>
                <ul class="help-list">
                    <li><strong>1. √Åreas:</strong> S√£o os pilares da sua vida (Ex: Sa√∫de, Carreira). Voc√™ pode criar novas ou editar as existentes.</li>
                    <li><strong>2. Objetivos (Bolhas):</strong> Dentro de cada √°rea, crie objetivos grandes (Ex: Perder 5kg).</li>
                    <li><strong>3. Metas:</strong> Dentro da bolha, adicione pequenas tarefas di√°rias. Cada tarefa feita d√° XP.</li>
                    <li><strong>4. N√≠vel & B√¥nus:</strong> Ao completar 100 XP, voc√™ passa de n√≠vel e desbloqueia a recompensa que definiu!</li>
                </ul>
                <button onclick="document.getElementById('modal-help').classList.remove('active')">Entendi!</button>
            </div>
        </div>

        <!-- MODAL: Objetivo -->
        <div id="modal-objective" class="modal-overlay">
            <div class="card modal-content">
                <h3 id="modalTitle">Novo Objetivo</h3>
                <label>T√≠tulo</label>
                <input type="text" id="objTitle" onkeypress="game.handleEnter(event, 'saveObj')">
                <label>Prazo</label>
                <input type="date" id="objDeadline">
                <label>Recompensa</label>
                <input type="text" id="objReward" onkeypress="game.handleEnter(event, 'saveObj')">
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="game.saveObjective()">Salvar</button>
                    <button onclick="game.closeModal()" class="secondary">Cancelar</button>
                </div>
                <button id="btnDeleteObj" onclick="game.deleteObjective()" class="danger" style="margin-top: 15px; display: none;">Excluir</button>
            </div>
        </div>

        <!-- MODAL: √Årea -->
        <div id="modal-area" class="modal-overlay">
            <div class="card modal-content">
                <h3 id="modalAreaTitle">Nova √Årea</h3>
                <input type="hidden" id="oldAreaName">
                <label>Nome da √Årea</label>
                <input type="text" id="newAreaName" placeholder="Ex: Carreira" onkeypress="game.handleEnter(event, 'saveArea')">
                <label>√çcone</label>
                <input type="text" id="newAreaIcon" value="‚ú®" style="font-size: 2rem; text-align: center; width: 80px;" maxlength="2">
                <div style="display: flex; gap: 10px;">
                    <button onclick="game.saveArea()">Salvar</button>
                    <button onclick="document.getElementById('modal-area').classList.remove('active')" class="secondary">Cancelar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- SERVICE WORKER (PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registrado!', reg))
                    .catch(err => console.log('SW falhou:', err));
            });
        }

        // --- DADOS ---
        const placeholdersDB = {
            'Sa√∫de': ['Perder 5kg', 'Correr 5km', 'Beber √°gua', 'Dormir cedo'],
            'Neg√≥cios': ['Lucro R$ 2k', '5 Clientes', 'Lan√ßar site'],
            'Finan√ßas': ['Renda Extra', 'Juntar R$ 10k', 'Quitar d√≠vida'],
            'Viagem': ['Ir pro Hava√≠', 'Mochil√£o', 'Visitar fam√≠lia'],
            'Sonhos': ['Casa Pr√≥pria', 'Escrever livro', 'Saltar de paraquedas'],
            'Relacionamentos': ['Noivado', 'Jantar rom√¢ntico', 'Fazer as pazes'],
            'Profissional': ['Promo√ß√£o', 'Novo emprego', 'Curso Ingl√™s'],
            'default': ['Novo Desafio', 'Superar limite', 'Projeto X']
        };

        const game = {
            data: {
                user: null,
                areas: { 'Neg√≥cios': [], 'Sa√∫de': [], 'Finan√ßas': [], 'Sonhos': [] },
                areaIcons: { 'Neg√≥cios': 'üíº', 'Sa√∫de': '‚ù§Ô∏è', 'Finan√ßas': 'üí∞', 'Sonhos': '‚ú®' }
            },
            state: {
                currentArea: null,
                currentObjIndex: null,
                isEditingAreas: false,
                modalMode: 'create',
                areaModalMode: 'create'
            },

            init: function() {
                const saved = localStorage.getItem('rpgVidaData_v5');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    this.data = { ...this.data, ...parsed };
                    if(!this.data.areaIcons) this.data.areaIcons = {};
                    if (this.data.user) {
                        this.showScreen('screen-dashboard');
                        this.updateWelcome();
                        this.renderDashboard();
                    }
                }
            },

            save: function() { localStorage.setItem('rpgVidaData_v5', JSON.stringify(this.data)); },

            handleEnter: function(e, action) {
                if (e.key === 'Enter') {
                    if (action === 'login') this.login();
                    if (action === 'addGoal') this.addGoal();
                    if (action === 'saveObj') this.saveObjective();
                    if (action === 'saveArea') this.saveArea();
                }
            },

            getSmartPlaceholder: function(area) {
                let keys = Object.keys(placeholdersDB);
                let match = keys.find(k => area.toLowerCase().includes(k.toLowerCase()));
                let opts = match ? placeholdersDB[match] : placeholdersDB['default'];
                return opts[Math.floor(Math.random() * opts.length)];
            },

            // --- FUN√á√ïES DE AJUDA ---
            openHelp: function() {
                document.getElementById('modal-help').classList.add('active');
            },

            // --- AUTH ---
            login: function() {
                const name = document.getElementById('userName').value;
                const avatar = document.getElementById('userAvatar').value;
                if (!name) return alert('Digite seu nome!');
                this.data.user = { name, avatar };
                this.save(); this.updateWelcome(); this.renderDashboard(); this.showScreen('screen-dashboard');
            },
            logout: function() { this.showScreen('screen-login'); },
            updateWelcome: function() { document.getElementById('welcomeMsg').innerText = `${this.data.user.avatar} ${this.data.user.name}`; },
            showScreen: function(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                this.state.isEditingAreas = false;
                if(id === 'screen-dashboard') this.renderDashboard();
            },

            // --- DASHBOARD & √ÅREAS ---
            renderDashboard: function() {
                const grid = document.getElementById('areasGrid');
                grid.innerHTML = '';
                
                if (this.state.isEditingAreas) {
                    document.getElementById('editAreaTip').style.display = 'block';
                    const addBtn = document.createElement('div');
                    addBtn.className = 'area-btn';
                    addBtn.style.borderStyle = 'dashed';
                    addBtn.innerHTML = '<span style="font-size:2rem; color:var(--success)">+</span><br>Nova';
                    addBtn.onclick = () => this.openAreaModal('create');
                    grid.appendChild(addBtn);
                } else {
                    document.getElementById('editAreaTip').style.display = 'none';
                }

                Object.keys(this.data.areas).forEach(areaName => {
                    const div = document.createElement('div');
                    div.className = `area-btn ${this.state.isEditingAreas ? 'editing' : ''}`;
                    let icon = this.data.areaIcons[areaName] || 'üåä';
                    
                    div.innerHTML = `<div class="area-icon-display">${icon}</div>${areaName}`;
                    
                    if (this.state.isEditingAreas) {
                        const controls = document.createElement('div');
                        controls.className = 'edit-controls';
                        controls.innerHTML = `
                            <button class="mini-btn btn-edit" onclick="event.stopPropagation(); game.openAreaModal('edit', '${areaName}')">‚úé</button>
                            <button class="mini-btn btn-del" onclick="event.stopPropagation(); game.deleteArea('${areaName}')">‚úñ</button>
                        `;
                        div.appendChild(controls);
                        div.onclick = null;
                    } else {
                        div.onclick = () => this.openArea(areaName);
                    }
                    grid.appendChild(div);
                });
            },

            toggleEditAreas: function() {
                this.state.isEditingAreas = !this.state.isEditingAreas;
                const btn = document.getElementById('btnEditAreas');
                btn.innerText = this.state.isEditingAreas ? '‚úÖ OK' : '‚úèÔ∏è Editar';
                btn.style.background = this.state.isEditingAreas ? 'var(--success)' : '';
                btn.style.color = this.state.isEditingAreas ? 'black' : 'white';
                btn.style.textShadow = this.state.isEditingAreas ? 'none' : '0 1px 2px black';
                this.renderDashboard();
            },

            openAreaModal: function(mode, areaName = '') {
                this.state.areaModalMode = mode;
                const modal = document.getElementById('modal-area');
                const title = document.getElementById('modalAreaTitle');
                const inputName = document.getElementById('newAreaName');
                const inputIcon = document.getElementById('newAreaIcon');
                const hiddenOld = document.getElementById('oldAreaName');

                if (mode === 'create') {
                    title.innerText = "Nova √Årea";
                    inputName.value = '';
                    inputIcon.value = '‚ú®';
                    hiddenOld.value = '';
                } else {
                    title.innerText = "Editar √Årea";
                    inputName.value = areaName;
                    inputIcon.value = this.data.areaIcons[areaName];
                    hiddenOld.value = areaName;
                }
                modal.classList.add('active');
            },

            saveArea: function() {
                const name = document.getElementById('newAreaName').value.trim();
                const icon = document.getElementById('newAreaIcon').value.trim() || '‚ú®';
                const oldName = document.getElementById('oldAreaName').value;
                
                if(!name) return;

                if (this.state.areaModalMode === 'create') {
                    if(this.data.areas[name]) return alert('√Årea j√° existe!');
                    this.data.areas[name] = [];
                    this.data.areaIcons[name] = icon;
                } else {
                    if (name !== oldName) {
                        if(this.data.areas[name]) return alert('Nome j√° em uso!');
                        this.data.areas[name] = this.data.areas[oldName];
                        delete this.data.areas[oldName];
                        delete this.data.areaIcons[oldName];
                    }
                    this.data.areaIcons[name] = icon;
                }

                this.save();
                document.getElementById('modal-area').classList.remove('active');
                this.renderDashboard();
            },

            deleteArea: function(areaName) {
                if(confirm(`Apagar "${areaName}" e tudo dentro dela?`)) {
                    delete this.data.areas[areaName];
                    delete this.data.areaIcons[areaName];
                    this.save(); this.renderDashboard();
                }
            },

            openArea: function(areaName) {
                this.state.currentArea = areaName;
                document.getElementById('areaTitle').innerText = areaName;
                this.renderBubbles();
                this.showScreen('screen-area');
            },

            // --- OBJETIVOS ---
            openModal: function(mode) {
                this.state.modalMode = mode;
                const modal = document.getElementById('modal-objective');
                const btnDelete = document.getElementById('btnDeleteObj');
                
                if (mode === 'create') {
                    document.getElementById('modalTitle').innerText = 'Novo Objetivo';
                    const ph = this.getSmartPlaceholder(this.state.currentArea);
                    document.getElementById('objTitle').placeholder = `Ex: ${ph}`;
                    document.getElementById('objTitle').value = '';
                    document.getElementById('objDeadline').value = '';
                    document.getElementById('objReward').value = '';
                    btnDelete.style.display = 'none';
                } else {
                    const obj = this.data.areas[this.state.currentArea][this.state.currentObjIndex];
                    document.getElementById('modalTitle').innerText = 'Editar';
                    document.getElementById('objTitle').value = obj.title;
                    document.getElementById('objDeadline').value = obj.deadline;
                    document.getElementById('objReward').value = obj.reward;
                    btnDelete.style.display = 'block';
                }
                modal.classList.add('active');
            },

            closeModal: function() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); },

            saveObjective: function() {
                const title = document.getElementById('objTitle').value;
                const deadline = document.getElementById('objDeadline').value;
                const reward = document.getElementById('objReward').value;
                if (!title || !deadline) return alert('Preencha tudo!');

                if (this.state.modalMode === 'create') {
                    this.data.areas[this.state.currentArea].push({
                        id: Date.now(), title, level: 1, deadline, reward, xpBalance: 0, goals: []
                    });
                } else {
                    const obj = this.data.areas[this.state.currentArea][this.state.currentObjIndex];
                    obj.title = title; obj.deadline = deadline; obj.reward = reward;
                    if(document.getElementById('screen-mission').classList.contains('active')) this.renderMissionScreen();
                }
                this.save(); this.closeModal(); this.renderBubbles();
            },

            deleteObjective: function() {
                if(confirm('Apagar?')) {
                    this.data.areas[this.state.currentArea].splice(this.state.currentObjIndex, 1);
                    this.save(); this.closeModal(); this.backToArea();
                }
            },

            renderBubbles: function() {
                const container = document.getElementById('bubblesContainer');
                container.innerHTML = '';
                const objectives = this.data.areas[this.state.currentArea];
                if(objectives.length === 0) { container.innerHTML = '<p style="opacity:0.6;">Vazio.</p>'; return; }

                objectives.forEach((obj, index) => {
                    const xpInfo = this.calculateXP(obj);
                    const bubble = document.createElement('div');
                    bubble.className = 'objective-bubble';
                    bubble.style.animationDelay = `${Math.random() * 2}s`;
                    const isLate = new Date().setHours(0,0,0,0) > new Date(obj.deadline + 'T00:00:00').setHours(0,0,0,0);
                    if(isLate) bubble.style.borderColor = 'var(--danger)';
                    
                    bubble.innerHTML = `
                        <div style="font-weight:bold; font-size: 1rem; line-height:1.2; margin-bottom:5px;">${obj.title}</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">Nvl ${obj.level}</div>
                        <div style="font-size:0.8rem; color:${isLate ? 'var(--danger)' : 'var(--primary)'}">${Math.floor(xpInfo.currentXP)}%</div>
                    `;
                    bubble.onclick = () => this.openMissionControl(index);
                    container.appendChild(bubble);
                });
            },

            // --- MISS√ïES ---
            openMissionControl: function(index) {
                this.state.currentObjIndex = index;
                this.renderMissionScreen();
                this.showScreen('screen-mission');
            },
            backToArea: function() { this.renderBubbles(); this.showScreen('screen-area'); },

            calculateXP: function(obj) {
                const total = obj.goals.length;
                if (total === 0) return { currentXP: obj.xpBalance, isComplete: false, pointsPerGoal: 0 };
                const done = obj.goals.filter(g => g.completed).length;
                const pointsPerGoal = 100 / total;
                const currentXP = obj.xpBalance + (done * pointsPerGoal);
                return { currentXP, isComplete: (done === total && total > 0), pointsPerGoal };
            },

            renderMissionScreen: function() {
                const obj = this.data.areas[this.state.currentArea][this.state.currentObjIndex];
                const xpInfo = this.calculateXP(obj);

                document.getElementById('missionTitle').innerText = obj.title;
                document.getElementById('missionLevel').innerText = `Nvl ${obj.level}`;
                
                const rewardContainer = document.getElementById('rewardContainer');
                document.getElementById('missionReward').innerText = obj.reward || 'Sem b√¥nus';

                if (xpInfo.isComplete) {
                    rewardContainer.className = 'reward-container reward-revealed';
                    rewardContainer.querySelector('.lock-icon').style.display = 'none';
                } else {
                    rewardContainer.className = 'reward-container reward-locked';
                    rewardContainer.querySelector('.lock-icon').style.display = 'block';
                }

                const today = new Date().setHours(0,0,0,0);
                const deadlineDate = new Date(obj.deadline + 'T00:00:00').setHours(0,0,0,0);
                const isLate = today > deadlineDate;
                const dateStr = new Date(obj.deadline).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                document.getElementById('missionDeadline').innerHTML = `Prazo: ${dateStr} ${isLate ? '<span style="color:var(--danger); font-weight:bold;">(ATRASADO)</span>' : ''}`;

                const barFill = document.getElementById('xpBarFill');
                const xpText = document.getElementById('xpText');
                if (xpInfo.currentXP < 0) {
                    barFill.style.width = Math.abs(xpInfo.currentXP) + '%';
                    barFill.className = 'xp-bar-fill negative';
                    xpText.innerText = `${Math.floor(xpInfo.currentXP)} XP (D√≠vida)`;
                } else {
                    let visualWidth = xpInfo.currentXP > 100 ? 100 : xpInfo.currentXP;
                    barFill.style.width = visualWidth + '%';
                    barFill.className = 'xp-bar-fill';
                    xpText.innerText = `${Math.floor(xpInfo.currentXP)} / 100 XP`;
                }
                document.getElementById('xpBalanceMsg').innerText = obj.xpBalance !== 0 ? `Saldo: ${obj.xpBalance} XP` : '';

                const btnLevelUp = document.getElementById('btnLevelUp');
                if (xpInfo.isComplete) {
                    btnLevelUp.style.display = 'block';
                    if (xpInfo.currentXP < 100) {
                        btnLevelUp.innerText = "‚ö†Ô∏è SALDO DEVEDOR";
                        btnLevelUp.disabled = true;
                        btnLevelUp.style.background = '#555';
                    } else {
                        btnLevelUp.innerText = "üéâ COMPLETAR N√çVEL";
                        btnLevelUp.disabled = false;
                        btnLevelUp.style.background = 'var(--success)';
                    }
                } else {
                    btnLevelUp.style.display = 'none';
                }

                const list = document.getElementById('goalsList');
                list.innerHTML = '';
                obj.goals.forEach((goal, gIndex) => {
                    const div = document.createElement('div');
                    div.className = 'goal-item';
                    div.innerHTML = `
                        <input type="checkbox" ${goal.completed ? 'checked' : ''} onchange="game.toggleGoal(${gIndex})">
                        <span class="goal-text" style="${goal.completed ? 'text-decoration:line-through; opacity:0.5' : ''}">${goal.text}</span>
                        <button onclick="game.deleteGoal(${gIndex})" style="background:transparent; color:#ff5252; border:none; font-size:1.2rem; padding:10px;">‚úñ</button>
                    `;
                    list.appendChild(div);
                });
            },

            addGoal: function() {
                const input = document.getElementById('newGoalInput');
                if (!input.value) return;
                this.data.areas[this.state.currentArea][this.state.currentObjIndex].goals.push({ text: input.value, completed: false });
                input.value = ''; this.save(); this.renderMissionScreen();
            },
            toggleGoal: function(idx) {
                const obj = this.data.areas[this.state.currentArea][this.state.currentObjIndex];
                obj.goals[idx].completed = !obj.goals[idx].completed;
                this.save(); this.renderMissionScreen();
            },
            deleteGoal: function(idx) {
                if(confirm('Apagar?')) {
                    this.data.areas[this.state.currentArea][this.state.currentObjIndex].goals.splice(idx, 1);
                    this.save(); this.renderMissionScreen();
                }
            },
            levelUp: function() {
                const obj = this.data.areas[this.state.currentArea][this.state.currentObjIndex];
                const today = new Date().setHours(0,0,0,0);
                const deadlineDate = new Date(obj.deadline + 'T00:00:00').setHours(0,0,0,0);
                let nextBalance = (today <= deadlineDate) ? 10 : -10;
                
                alert(`N√≠vel ${obj.level} Conclu√≠do!\nB√¥nus: ${obj.reward}\nPr√≥ximo Saldo: ${nextBalance > 0 ? '+' : ''}${nextBalance} XP`);

                obj.level++; obj.xpBalance = nextBalance; obj.goals = [];
                const newDeadline = prompt("Nova data (AAAA-MM-DD):", obj.deadline);
                if(newDeadline) obj.deadline = newDeadline;
                const newReward = prompt("Novo b√¥nus:", "Novo B√¥nus");
                if(newReward) obj.reward = newReward;

                this.save(); this.renderMissionScreen();
            }
        };
        game.init();
    </script>
</body>
</html>
